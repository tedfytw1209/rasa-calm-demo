flows:
  target_trail_emulation_qa:
    name: target trail emulation question answering
    description: Support flow to emulate target trail for QA purposes
    nlu_trigger:
    - intent:
        name: target_trail_emulation_qa
        confidence_threshold: 0.5
    steps:
      - id: classify_intent            # optional, but now attached to a real step
        call: classify_user_intent     # this is the call step
        next:
          - if: slots.user_intent = "pipeline"
            then: call_pipeline_assistant
          - if: slots.user_intent = "evidence"
            then: call_evidence_search
          - if: slots.user_intent = "concept"
            then: call_concept_explain
          - if: slots.user_intent = "options"
            then: call_options_recommendation
          - else:
            then: utter_cancel_qa

      - call: check_finish_pipeline
        next:
          - if: not slots.finish
            then: call_pipeline_assistant
          - else: call_export_pipeline_json
      # The "then" above must point to step IDs in THIS flow:
      - id: call_pipeline_assistant
        call: pipeline_assistant
      - id: call_evidence_search
        call: evidence_search
      - id: call_concept_explain
        call: concept_explain
      - id: call_options_recommendation
        call: options_recommendation
      - id: call_export_pipeline_json
        call: export_pipeline_json

  classify_user_intent:
    name: classify user intent
    description: You are the Workflow Classifier for the TTE Protocol Builder. User intent classification for QA purposes. rag ↔ intent is evidence; define ↔ intent is concept; compare, options ↔ intent is options. Return { user_intent evidence | concept | options }
    steps:
      - collect: user_intent
        reset_after_flow_ends: True
        ask_before_filling: False
      - action: utter_cancel_qa

  evidence_search:
    name: evidence search
    description: Evidence Assistant agent. Retrieve and summarize examples from annotated TTE study data or literature (via RAG).
    steps:
      - action: action_trigger_search
      - action: utter_cancel_qa

  concept_explain:
    name: concept explain
    description: Concept Explainer agent for a Target Trial Emulation (TTE) protocol. Explain the meaning of a given concept or term used in TTE studies (via RAG).
    steps:
      - action: action_trigger_search
      - action: utter_cancel_qa
  
  options_recommendation:
    name: options recommendation
    description: Options Recommender agent. Recommend suitable options for various components of a Target Trial Emulation (TTE) protocol (via RAG).
    steps:
      - action: action_options_search
      - action: utter_options_list
      - action: utter_cancel_qa

  pipeline_assistant:
      name: pipeline assistant
      description: Pipeline Assistant agent for guiding users through the steps of building a Target Trial Emulation (TTE) protocol.
      steps:
        - action: utter_component_ask
        - collect: current_component
          ask_before_filling: true
          next:
            - if: slots.current_component = "eligibility"
              then: eligibility_details
            - else: END   # later you can route other components here
        - id: eligibility_details
          collect: eligibility_population
        - collect: eligibility_inclusioncriteria
        - collect: eligibility_exclusioncriteria
        - collect: eligibility_computablephenotype
        - collect: eligibility_population_evaluation
        - action: action_mark_component_done

  check_finish_pipeline:
      name: check finish pipeline
      description: Check if the user has finished building the TTE protocol.
      steps:
        - action: action_check_finish_pipeline

  export_pipeline_json:
      name: export pipeline json
      description: Export the constructed TTE protocol as JSON once all components are finished.
      steps:
        - action: action_export_protocol_json