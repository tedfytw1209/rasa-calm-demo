version: "3.1"

flows:
  target_trail_emulation_qa:
    name: target trail emulation question answering
    description: Support flow to emulate target trail for QA purposes
    nlu_trigger:
      - intent:
          name: target_trail_emulation_qa
          confidence_threshold: 0.5
    steps:
      - id: classify_intent
        call: classify_user_intent
        next:
          - if: slots.user_intent = "evidence"
            then: call_evidence_search
          - if: slots.user_intent = "concept"
            then: call_concept_explain
          - if: slots.user_intent = "options"
            then: call_options_recommendation
          - else: call_cancel_qa
      # These are call steps into other flows
      - id: call_evidence_search
        call: evidence_search
      - id: call_concept_explain
        call: concept_explain
      - id: call_options_recommendation
        call: options_recommendation
      - id: call_cancel_qa
        call: cancel_qa

  classify_user_intent:
    name: classify user intent
    description: You are the Workflow Classifier for the TTE Protocol Builder. User intent classification for QA purposes. rag ↔ intent is evidence; define ↔ intent is concept; compare, options ↔ intent is options. Return { user_intent include evidence | concept | options }
    steps:
      - collect: user_intent
        reset_after_flow_ends: true
        ask_before_filling: false

  evidence_search:
    name: evidence search
    description: Evidence Assistant agent. Retrieve and summarize examples from annotated TTE study data or literature (via RAG).
    nlu_trigger:
      - intent:
          name: tte_evidence_search
          confidence_threshold: 0.5
    steps:
      - collect: concept_to_explain
        reset_after_flow_ends: true
        ask_before_filling: false
      - action: action_trigger_search
        next: END

  concept_explain:
    name: concept explain
    description: Concept Explainer agent for a Target Trial Emulation (TTE) protocol. Explain the meaning of a given concept or term used in TTE studies (via RAG).
    nlu_trigger:
      - intent:
          name: tte_concept_question
          confidence_threshold: 0.5
    steps:
      - collect: concept_to_explain
        reset_after_flow_ends: true
        ask_before_filling: false
      - action: action_trigger_search
        next: END
  
  options_recommendation:
    name: options recommendation
    description: Options Recommender agent. Recommend suitable options for a field in Target Trial Emulation (TTE).
    nlu_trigger:
      - intent:
          name: tte_options_recommendation
          confidence_threshold: 0.5
    steps:
      - id: fill_tte_field
        collect: tte_field
        reset_after_flow_ends: true
        ask_before_filling: false
      - id: run_option_search
        action: action_options_search
        next:
          - if: slots.option_search_finish = true
            then: show_options
          - else: fill_tte_field
      - id: show_options
        action: utter_options_list
        next: END

  cancel_qa:
    name: cancel qa
    description: Cancel the QA session.
    steps:
      - action: utter_cancel_qa
        next: END
